{#-
Kodi addon.xml template with support for init and update modes.

Init mode (no existing addon.xml):
  - Generates complete addon.xml with placeholder metadata
  - Includes base structure with <news> insertion point

Update mode (existing addon.xml):
  - Reads existing addon.xml file
  - Updates version attribute using string replacement
  - Appends new release news before </news> insertion point
  - Preserves all existing metadata and structure

Insertion point:
  The <news> tag serves as the insertion point.
  PSR splits on <news> and reassembles with new content before </news>.
-#}

{#- Macro: Generate news content for a release -#}
{%- macro generate_news_content(version) -%}
Release v{{ version }}

{%- set release = ctx.history.released[version] -%}
{%- set elements = release.get("elements") if release is mapping else release.elements -%}

{%- set section_for = {
  "feat": ["feat", "features"],
  "fix": ["fix", "bug fixes"],
  "perf": ["perf", "performance"]
} -%}

{%- set order = ["feat", "fix", "perf"] -%}

{%- for tag in order -%}
{%- set possible_keys = section_for[tag] -%}
{%- for key in possible_keys -%}
  {%- if key in elements and elements[key] -%}
    {%- for item in elements[key] -%}
      {% for d in item.descriptions %}
[{{ tag }}] {{ d }}
      {%- endfor -%}
      {%- for bd in item.breaking_descriptions -%}
[{{ tag }}] BREAKING: {{ bd }}
      {%- endfor -%}
    {%- endfor -%}
  {%- endif -%}
{%- endfor -%}
{%- endfor -%}
{%- endmacro -%}

{#- Macro: Generate complete addon.xml from scratch -#}
{%- macro render_complete_addon(version) -%}
<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<addon id="script.module.placeholder" name="Placeholder" version="{{ version }}" provider-name="Unknown">
    <requires>
        <import addon="xbmc.python" version="3.0.0"/>
    </requires>
    <extension point="xbmc.python.module" library="lib"/>
    <extension point="xbmc.addon.metadata">
        <summary>Placeholder addon for semantic release</summary>
        <description>This is a placeholder addon.xml. Update metadata (id, name, provider-name) as needed.</description>
        <platform>all</platform>
        <news>
{{- generate_news_content(version) | indent(8) }}
        </news>
    </extension>
</addon>
{%- endmacro -%}

{#- Calculate latest version -#}
{%- set versions = ctx.history.released.keys() | list | sort -%}
{%- if not versions -%}
  {%- set latest_version = "0.0.0" -%}
{%- else -%}
  {%- set latest_version = versions | sort(reverse=True) | first -%}
{%- endif -%}

{#- Render based on mode -#}
{%- if ctx.existing_addon_file -%}
  {#- Update mode: read existing, update version and news -#}
  {%- set existing_addon = ctx.existing_addon_file | read_file | safe -%}
  {%- set new_news = generate_news_content(latest_version) -%}
  {#- Find news section -#}
  {%- set news_start = existing_addon.find('<news>') -%}
  {%- set news_end = existing_addon.find('</news>') -%}
  {%- if news_start >= 0 and news_end > news_start -%}
    {#- Extract before and after news -#}
    {%- set before_news = existing_addon[:news_start] -%}
    {%- set after_news = existing_addon[news_end + 7:] -%}
    {#- Find and update version in the <addon ...> element (search backwards from before news end) -#}
    {%- set addon_start = before_news.rfind('<addon') -%}
    {%- if addon_start >= 0 -%}
      {%- set addon_tag_end = before_news.find('>', addon_start) -%}
      {%- if addon_tag_end > addon_start -%}
        {%- set addon_tag = before_news[addon_start:addon_tag_end + 1] -%}
        {%- set before_addon = before_news[:addon_start] -%}
        {%- set after_addon = before_news[addon_tag_end + 1:] -%}
        {#- Find version= within the addon tag -#}
        {%- set version_in_tag_start = addon_tag.rfind('version="') -%}
        {%- if version_in_tag_start >= 0 -%}
          {%- set quote_after_version = addon_tag.find('"', version_in_tag_start + 9) -%}
          {%- if quote_after_version > version_in_tag_start -%}
            {%- set updated_addon_tag = addon_tag[:version_in_tag_start + 9] ~ latest_version ~ addon_tag[quote_after_version:] -%}
            {%- set updated = before_addon ~ updated_addon_tag ~ after_addon -%}
          {%- else -%}
            {%- set updated = before_news -%}
          {%- endif -%}
        {%- else -%}
          {%- set updated = before_news -%}
        {%- endif -%}
      {%- else -%}
        {%- set updated = before_news -%}
      {%- endif -%}
    {%- else -%}
      {%- set updated = before_news -%}
    {%- endif -%}
    {{- updated -}}
    <news>
{{- new_news | indent(8) }}
    </news>
    {{- after_news -}}
  {%- else -%}
    {#- Fallback if news section not found -#}
    {{- render_complete_addon(latest_version) -}}
  {%- endif -%}
{%- else -%}
  {#- Init mode: generate complete addon.xml -#}
  {{- render_complete_addon(latest_version) -}}
{%- endif -%}
