{#-
Kodi addon.xml template with support for init and update modes.

Init mode (first release):
  - Generates complete addon.xml with placeholder metadata
  - Uses first available version from release history
  - Includes basic structure: requires, extension, metadata

Update mode (subsequent releases):
  - Reads existing addon.xml to preserve metadata (id, name, provider-name, requires)
  - Updates version attribute (handled by PSR version_variables, not this template)
  - Updates news section with latest release notes only
  - Preserves all other XML elements unchanged

Version handling:
  PSR's version_variables config (in pyproject.toml) handles version attribute updates.
  Example: version_variables = ["path/to/addon.xml:version:nf"]
  This allows surgical version updates without template involvement.

News section:
  Latest release formatted with commits grouped by type (feat/fix/perf/etc).
  Update mode preserves only the latest release; prior versions are trimmed.
-#}

{#- Macro: Generate complete addon.xml -#}
{%- macro render_complete_addon(version, metadata) -%}
<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<addon id="{{ metadata.id }}" name="{{ metadata.name }}" version="{{ version }}" provider-name="{{ metadata.provider_name }}">
    <requires>
        <import addon="xbmc.python" version="3.0.0"/>
    </requires>
    <extension point="xbmc.python.module" library="lib"/>
    <extension point="xbmc.addon.metadata">
        <summary>{{ metadata.summary }}</summary>
        <description>{{ metadata.description }}</description>
        <platform>all</platform>
        <news>
Release v{{ version }}

{%- set release = ctx.history.released[version] -%}
{%- set elements = release.get("elements") if release is mapping else release.elements -%}

{%- set section_for = {
  "feat": ["feat", "features"],
  "fix": ["fix", "bug fixes"],
  "perf": ["perf", "performance"]
} -%}

{%- set order = ["feat", "fix", "perf"] -%}

{%- for tag in order -%}
{%- set possible_keys = section_for[tag] -%}
{%- for key in possible_keys -%}
  {%- if key in elements and elements[key] -%}
    {%- for item in elements[key] -%}
      {% for d in item.descriptions %}
[{{ tag }}] {{ d }}
      {%- endfor -%}
      {%- for bd in item.breaking_descriptions -%}
[{{ tag }}] BREAKING: {{ bd }}
      {%- endfor -%}
    {%- endfor -%}
  {%- endif -%}
{%- endfor -%}
{%- endfor -%}
        </news>
    </extension>
</addon>
{%- endmacro -%}

{#- Metadata definitions for init and update modes -#}
{%- set placeholder_meta = {"id": "script.module.placeholder", "name": "Placeholder", "provider_name": "Unknown", "summary": "Placeholder addon for semantic release", "description": "This is a placeholder addon.xml. Update metadata (id, name, provider-name) as needed."} -%}
{%- set existing_meta = {"id": "script.module.placeholder", "name": "Placeholder", "provider_name": "Unknown", "summary": "Placeholder addon for semantic release", "description": "Metadata from existing addon.xml (or placeholder if read failed)"} -%}

{#- Template execution: Calculate version and render output -#}
{%- set versions = ctx.history.released.keys() | list | sort -%}
{%- if not versions -%}
  {#- No releases yet; fallback to 0.0.0 -#}
  {%- set latest_version = "0.0.0" -%}
{%- else -%}
  {#- Sort versions to ensure latest is selected (defensive, not relying on dict order) -#}
  {%- set latest_version = versions | sort(reverse=True) | first -%}
{%- endif -%}

{#- Render output based on changelog mode -#}
{%- if ctx.changelog_mode == "update" -%}
  {#- Update mode: Preserve existing file structure, update version and news via PSR -#}
  {#- Note: Version updates handled by PSR version_variables config -#}
  {{- render_complete_addon(latest_version, existing_meta) -}}
{%- else -%}
  {#- Init mode: Generate complete addon.xml with placeholders -#}
  {{- render_complete_addon(latest_version, placeholder_meta) -}}
{%- endif -%}
