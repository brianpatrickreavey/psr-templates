{#-
Kodi addon.xml template that consumes psr_prepare context and PSR's release history.

Context variables expected (provided by psr_prepare):
  - addon: Addon metadata dict containing:
    - id: Addon ID
    - name: Display name
    - provider_name: Provider name (converted from provider-name)
    - description: Description
    - summary: Short summary
    - license: License
    - disclaimer: Disclaimer
    - requires: Array of required addons with versions
    - news_types: Commit type â†’ Kodi label mapping
    - unknown_extensions: Serialized XML of extensions not managed by template

Context variables (from PSR):
  - ctx: PSR's context object with history.released containing release objects
-#}
{%- set releases = ctx.history.released.values() | list -%}
{%- set sorted_releases = releases | sort(attribute='version', reverse=True) -%}
{%- set latest_release = sorted_releases[0] if sorted_releases else none -%}
<?xml version="1.0" encoding="UTF-8"?>
<addon id="{{ addon.id }}" name="{{ addon.name }}" version="{{ latest_release.version if latest_release else "0.0.0" }}" provider-name="{{ addon.provider_name }}">
  <requires>
    {%- for req in addon.requires %}
    <import addon="{{ req.addon }}" version="{{ req.version }}" />
    {%- endfor %}
  </requires>
  {%- if addon.unknown_extensions | trim %}
  {{ addon.unknown_extensions | trim | safe }}
  {%- endif %}
  <extension point="xbmc.addon.metadata">
    {%- if addon.summary %}
    <summary>{{ addon.summary }}</summary>
    {%- endif %}
    {%- if addon.description %}
    <description>{{ addon.description }}</description>
    {%- endif %}
    {%- if addon.disclaimer %}
    <disclaimer>{{ addon.disclaimer }}</disclaimer>
    {%- endif %}
    {%- if addon.license %}
    <license>{{ addon.license }}</license>
    {%- endif %}
    {% if latest_release -%}
    <news>v{{ latest_release.version }}{% if latest_release.tagged_date %} ({{ latest_release.tagged_date.strftime("%Y-%m-%d") }}){% endif %}

    {%- set commit_tags = {"features": "feat", "bug fixes": "fix", "performance improvements": "perf", "documentation": "docs", "refactoring": "refactor", "testing": "test", "continuous integration": "ci", "chores": "chore"} -%}
    {%- set p1_keys = ["features"] -%}
    {%- set p2_keys = ["bug fixes", "performance improvements"] -%}
    {%- set p3_keys = ["documentation", "refactoring", "testing", "continuous integration", "chores"] -%}
    {%- set rendered_keys = p1_keys + p2_keys + p3_keys -%}
    {%- set elements = latest_release.get("elements", {}) -%}
    {#- P1: Features -#}
    {%- for key in p1_keys -%}
    {%- if key in elements and elements[key] %}
    {% for item in elements[key] -%}
    [{{ commit_tags.get(key, key) }}] {{ item.descriptions[0] if item.descriptions else "" }}
    {% endfor -%}
    {%- endif -%}
    {%- endfor -%}
    {#- P2: Bug Fixes & Performance -#}
    {%- for key in p2_keys -%}
    {%- if key in elements and elements[key] %}
    {% for item in elements[key] -%}
    [{{ commit_tags.get(key, key) }}] {{ item.descriptions[0] if item.descriptions else "" }}
    {% endfor -%}
    {%- endif -%}
    {%- endfor -%}
    {#- P3: Other categories -#}
    {%- for key in p3_keys -%}
    {%- if key in elements and elements[key] %}
    {% for item in elements[key] -%}
    [{{ commit_tags.get(key, key) }}] {{ item.descriptions[0] if item.descriptions else "" }}
    {% endfor -%}
    {%- endif -%}
    {%- endfor -%}
    {#- Catch-all: Any remaining types -#}
    {%- for key in elements | dictsort -%}
    {%- if key not in rendered_keys and elements[key] %}
    {% for item in elements[key] -%}
    [{{ commit_tags.get(key, key | replace(" ", "-")) }}] {{ item.descriptions[0] if item.descriptions else "" }}
    {% endfor -%}
    {%- endif -%}
    {%- endfor -%}
    </news>
    {%- else %}
    <news></news>
    {%- endif %}
  </extension>
</addon>
