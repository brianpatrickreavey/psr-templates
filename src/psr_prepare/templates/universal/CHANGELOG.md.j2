{#-
Markdown changelog template with support for init and update modes.

Init mode (no existing CHANGELOG.md):
  - Generates complete changelog with all releases from history
  - All versions included, newest first (reverse chronological order)
  - Insertion flag marker placed right after header for future updates

Update mode (existing CHANGELOG.md):
  - Detects mode via ctx.existing_changelog_file context variable
  - Generates only the latest release
  - Includes insertion flag marker after new release
  - PSR inserts new content before the flag, pushing old content down
  - Result: newest releases always appear first, all history preserved

Insertion flag behavior:
  Marker: <!-- version list -->
  Position: After newest release content, before older releases
  Effect: New releases get inserted here, pushing older releases down

Example evolution:
  v0.1.0 (init):   # Changelog ... <!-- version list --> ## v0.1.0 ...
  v0.2.0 (update): # Changelog ... ## v0.2.0 ... <!-- version list --> ## v0.1.0 ...
  v1.0.0 (update): # Changelog ... ## v1.0.0 ... <!-- version list --> ## v0.2.0 ... ## v0.1.0 ...

Release sections:
  Commits organized by type: features, bug fixes, performance, documentation, refactoring, testing, chores
  Section headers formatted as title case.
-#}
# Changelog

All notable changes to this project will be documented in this file.

{%- set releases = ctx.history.released.values() | list -%}
{%- set sorted_releases = releases | sort(attribute='version', reverse=True) -%}

{%- if ctx.existing_changelog_file -%}
  {#- Update mode: Generate only the latest release -#}
  {%- set latest_release = sorted_releases[0] if sorted_releases else none -%}
  {%- if latest_release -%}

## v{{ latest_release.version }} ({{ latest_release.tagged_date.strftime('%Y-%m-%d') if latest_release.tagged_date else 'Unreleased' }})

{%- set elements = latest_release.get("elements", {}) -%}
{%- set p1_keys = ["features"] -%}
{%- set p2_keys = ["bug fixes", "performance improvements"] -%}
{%- set p3_keys = ["documentation", "refactoring", "testing", "continuous integration", "chores"] -%}
{%- set rendered_keys = p1_keys + p2_keys + p3_keys -%}
{%- set section_titles = {"features": "Features", "bug fixes": "Bug Fixes", "performance improvements": "Performance Improvements", "documentation": "Documentation", "refactoring": "Refactoring", "testing": "Testing", "continuous integration": "Continuous Integration", "chores": "Chores", "unknown": "Other Changes"} -%}
{#- P1: Features (Minor version) -#}
{%- for key in p1_keys -%}
{%- if key in elements and elements[key] %}

### {{ section_titles.get(key, key | title) }}

{% for item in elements[key] -%}
- {{ item.descriptions[0] if item.descriptions else "" }}
{% endfor -%}
{%- endif -%}
{%- endfor -%}
{#- P2: Bug Fixes & Performance (Patch version) -#}
{%- for key in p2_keys -%}
{%- if key in elements and elements[key] %}

### {{ section_titles.get(key, key | title) }}

{% for item in elements[key] -%}
- {{ item.descriptions[0] if item.descriptions else "" }}
{% endfor -%}
{%- endif -%}
{%- endfor -%}
{#- P3: Other categories -#}
{%- for key in p3_keys -%}
{%- if key in elements and elements[key] %}

### {{ section_titles.get(key, key | title) }}

{% for item in elements[key] -%}
- {{ item.descriptions[0] if item.descriptions else "" }}
{% endfor -%}
{%- endif -%}
{%- endfor -%}
{#- Catch-all: Any remaining uncategorized types -#}
{%- for key in elements | dictsort -%}
{%- if key not in rendered_keys and elements[key] %}

### {{ section_titles.get(key, key | title) }}

{% for item in elements[key] -%}
- {{ item.descriptions[0] if item.descriptions else "" }}
{% endfor -%}
{%- endif -%}
{%- endfor -%}
<!-- version list -->
  {%- endif -%}
{%- else -%}
  {#- Init mode: Generate complete changelog, all releases -#}
  {%- for release in sorted_releases %}

## v{{ release.version }} ({{ release.tagged_date.strftime('%Y-%m-%d') if release.tagged_date else 'Unreleased' }})

{%- set elements = release.get("elements", {}) %}
{%- set p1_keys = ["features"] %}
{%- set p2_keys = ["bug fixes", "performance improvements"] %}
{%- set p3_keys = ["documentation", "refactoring", "testing", "continuous integration", "chores"] %}
{%- set rendered_keys = p1_keys + p2_keys + p3_keys %}
{%- set section_titles = {"features": "Features", "bug fixes": "Bug Fixes", "performance improvements": "Performance Improvements", "documentation": "Documentation", "refactoring": "Refactoring", "testing": "Testing", "continuous integration": "Continuous Integration", "chores": "Chores", "unknown": "Other Changes"} %}
{#- P1: Features (Minor version) -#}
{%- for key in p1_keys %}
{%- if key in elements and elements[key] %}

### {{ section_titles.get(key, key | title) }}

{% for item in elements[key] %}
- {{ item.descriptions[0] if item.descriptions else "" }}
{%- endfor %}
{%- endif %}
{%- endfor %}
{#- P2: Bug Fixes & Performance (Patch version) -#}
{%- for key in p2_keys %}
{%- if key in elements and elements[key] %}

### {{ section_titles.get(key, key | title) }}

{% for item in elements[key] %}
- {{ item.descriptions[0] if item.descriptions else "" }}
{%- endfor %}
{%- endif %}
{%- endfor %}
{#- P3: Other categories -#}
{%- for key in p3_keys %}
{%- if key in elements and elements[key] %}

### {{ section_titles.get(key, key | title) }}

{% for item in elements[key] %}
- {{ item.descriptions[0] if item.descriptions else "" }}
{%- endfor %}
{%- endif %}
{%- endfor %}
{#- Catch-all: Any remaining uncategorized types -#}
{%- for key in elements | dictsort %}
{%- if key not in rendered_keys and elements[key] %}

### {{ section_titles.get(key, key | title) }}

{% for item in elements[key] %}
- {{ item.descriptions[0] if item.descriptions else "" }}
{%- endfor %}
{%- endif %}
{%- endfor %}
{%- endfor %}
<!-- version list -->
{%- endif -%}
