{#-
Markdown changelog template with support for init and update modes.

Init mode (no existing CHANGELOG.md):
  - Generates complete changelog with all releases from history
  - All versions included, newest first (reverse chronological order)
  - Insertion flag marker placed right after header for future updates

Update mode (existing CHANGELOG.md):
  - Detects mode via ctx.existing_changelog_file context variable
  - Generates only the latest release
  - Includes insertion flag marker after new release
  - PSR inserts new content before the flag, pushing old content down
  - Result: newest releases always appear first, all history preserved

Insertion flag behavior:
  Marker: <!-- version list -->
  Position: After newest release content, before older releases
  Effect: New releases get inserted here, pushing older releases down

Example evolution:
  v0.1.0 (init):   # Changelog ... <!-- version list --> ## v0.1.0 ...
  v0.2.0 (update): # Changelog ... ## v0.2.0 ... <!-- version list --> ## v0.1.0 ...
  v1.0.0 (update): # Changelog ... ## v1.0.0 ... <!-- version list --> ## v0.2.0 ... ## v0.1.0 ...

Release sections:
  Commits organized by type: features, bug fixes, performance, documentation, refactoring, testing, chores
  Section headers formatted as title case.
-#}
# Changelog

All notable changes to this project will be documented in this file.

{%- set releases = ctx.history.released.values() | list -%}
{%- set sorted_releases = releases | sort(attribute='version', reverse=True) -%}

{%- if ctx.existing_changelog_file -%}
  {#- Update mode: Generate only the latest release -#}
  {%- set latest_release = sorted_releases[0] if sorted_releases else none -%}
  {%- if latest_release -%}

## v{{ latest_release.version }} ({{ latest_release.tagged_date.strftime('%Y-%m-%d') if latest_release.tagged_date else 'Unreleased' }})

<!-- DEBUG: Elements keys = {{ latest_release.get("elements", {}).keys() | list }} -->

{%- set elements = latest_release.get("elements", {}) -%}
{%- set key_mapping = {"feat": "Features", "fix": "Bug Fixes", "perf": "Performance Improvements"} -%}
{%- set alt_keys = {"feat": "features", "fix": "bug fixes", "perf": "performance"} -%}
{%- for tag, section_name in key_mapping.items() -%}
{%- set key_to_use = tag if tag in elements else alt_keys[tag] -%}
{%- if key_to_use in elements and elements[key_to_use] %}

### {{ section_name }}

{% for item in elements[key_to_use] -%}
- {{ item.descriptions[0] if item.descriptions else "" }}
{% endfor -%}
{%- endif -%}
{%- endfor -%}
<!-- version list -->
  {%- endif -%}
{%- else -%}
  {#- Init mode: Generate complete changelog, all releases -#}
  {%- for release in sorted_releases %}

## v{{ release.version }} ({{ release.tagged_date.strftime('%Y-%m-%d') if release.tagged_date else 'Unreleased' }})

<!-- DEBUG: Elements keys = {{ release.get("elements", {}).keys() | list }} -->

{%- set elements = release.get("elements", {}) %}
{%- set key_mapping = {"feat": "Features", "fix": "Bug Fixes", "perf": "Performance Improvements"} %}
{%- set alt_keys = {"feat": "features", "fix": "bug fixes", "perf": "performance"} %}
{%- for tag, section_name in key_mapping.items() %}
{%- set key_to_use = tag if tag in elements else alt_keys[tag] %}
{%- if key_to_use in elements and elements[key_to_use] %}

### {{ section_name }}

{% for item in elements[key_to_use] %}
- {{ item.descriptions[0] if item.descriptions else "" }}
{%- endfor %}
{%- endif %}
{%- endfor %}
{%- endfor %}
<!-- version list -->
{%- endif -%}
